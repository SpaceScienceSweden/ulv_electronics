\documentclass{article}
\usepackage{listings}
\usepackage[table]{xcolor}
\usepackage{varioref}
\usepackage{float}
\begin{document}

\title{KUB manual}
\date{October 15, 2017}
\author{Tomas H\"ardin}

\maketitle

\newpage

\tableofcontents
\listoffigures
\listoftables

\newpage

\section{Greeting}
Hello world!



Culpa aliquid aperiam consequatur iste aut corrupti. Eos non harum dolor corrupti magnam consequuntur quod. Eos et quam culpa asperiores inventore ad distinctio sunt. Non in alias facilis quam quis vero quod dignissimos. Culpa ipsam velit quia. Ipsa eum enim repudiandae ut sunt doloribus.

Aut assumenda aut asperiores. Rerum ut nihil quisquam et. Quia et tempora vel. Illo excepturi soluta repellendus id debitis. Totam fuga doloribus exercitationem eius.

Et dolores amet id velit. Et ab saepe suscipit temporibus iusto. Odio dicta error voluptas veritatis ab ut aut doloribus. Et facere illo autem ea saepe accusantium eos minus.

Quis quidem porro tempora consequatur. Voluptatibus adipisci quibusdam illo magnam. Ut consequatur quia ipsum. Enim ea tenetur mollitia sed quaerat et neque officiis. Nostrum harum explicabo ut.

Culpa quia voluptas cumque officia. Impedit est ad et assumenda dolorem ex et. Voluptatem atque alias dicta ratione laborum modi rem.

\section{Assembly}


The instrument consists of a stainless steel skeleton into which a number of plates are screwed.
All plates have a printed circuit board (PCB) attached via standoffs or screwed directly to the plate.
The combination of board and plate is called a module.
In this section we assume all PCBs have already been soldered and cleaned.

The following tools and materials are needed:

\begin{itemize}
\item Wire cutters
\item Wire strippers suitable for 0.4 mm and 0.9 mm diameter wire (26 and 20 AWG). Strippers with fixed holes are recommended
\item A small round or semi-round file
\item Torque wrenches capable of 0.3 Nm, 0.8 Nm and 2.0 Nm with the following bits:
\begin{itemize}
\item PH1 Phillips
\item 9IP Torx-Plus or T10 Torx
\item 4.5 mm hex socket
\item 5.5 mm hex socket
\item 7.0 mm hex socket
\end{itemize}
\item Loctite 638
\item Scotch-Weld 2216
\item Soldering station
\item Helping hands
\item 60/40 or 63/37 leaded solder
\item Solder flux
\item White gloves for handling silver
\item Two fine paintbrushes
\item Citadel Chaos Black primer
\item The Army Painter WP1101 Matt Black
\item Electrolube SCP03G Silver Conductive Paint
\item Toothpicks
\item Heat gun
\item 0.62 $mm^2$ / 20 AWG Alpha Wire 5856 WH005 PTFE wire
\item 2.4 mm $\rightarrow$ 1.2 mm Kynar shrink tube
\item Masking tape
\item Maxon EC motor can vice (3D printed)
\end{itemize}

The subsections that follow are ordered in the recommended order of assembly.
The way the pin headers fit into corresponding sockets mean that the power4 module must be mounted first,
then the cpu3 and credits modules can be mounted, and finally the fieldmill9 modules can be mounted.
It's useful to mount the credits module last so that the mating of the fieldmill9 and cpu3 modules can be checked,
and power-on tests performed.

Use white gloves when handling any silver parts, to prevent them from being contaminated.
Each aluminium plate requires 16 silver plates M3 screws (?? mm long, Torx T10) to mount it to the skeleton, 96 total.

All M3 screws are torqued to 0.8 Nm and all M2 screws are torqued to 0.3 Nm.

\subsection{power4}

Parts needed:

\begin{itemize}
\item One (1) power4 PCB, soldered and cleaned
\item One (1) silver plated bottom aluminium plate (2mm thick)
\item Two (2) power4 aluminium standoffs
\item Four (4) PEEK washers (top kind)
\item Four (4) PEEK washers (bottom kind)
\item Twentyfour (24) silver plated M3 screws, ?? length inluding head (Torx T10)
\item Four (4) pieces of Alpha Wire 5856 WH005 PTFE wire (TODO: length)
\item 2.4 mm $\rightarrow$ 1.2 mm Kynar shrink tube
\item One (1) DE-9 male connector
\item A set of DE-9 panel mounting screws, washers and nuts
\item Zip ties
\end{itemize}

Solder the four PTFE wires to the DE-9 connector, see figure TODO.
Use Kynar shrink tubing to protect the solder points.

Fasten the DE-9 connector to the aluminium plate (inside or outside??) using the screws, washers and nuts.
Torque to 0.8 Nm.
Screw the standoffs to the plate, 0.8 Nm.

Solder the four PTFE wires to the appropriate places on the power4 board, see figure TODO.
Zip tie the wires together at both ends or in the middle if there isn't enough room.

Place bottom PEEK washers on the standoffs, then the power4 board on the standoffs and finally the top wasters on top.
Screw everything in place using M3 screws, 0.8 Nm.

Screw the finished module to the skeleton using M3 screws, 0.8 Nm.

\subsection{cpu3}

Parts needed:

\begin{itemize}
\item One (1) cpu3 PCB, soldered and cleaned
\item One (1) silver plated cpu3 aluminium plate
\item One (1) cpu3/credits aluminium standoff, short kind
\item One (1) cpu3/credits aluminium standoff, long kind
\item Four (4) PEEK washers (top kind)
\item Four (4) PEEK washers (bottom kind)
\item Twentyfour (24) silver plated M3 screws, ?? length inluding head (Torx T10)
\end{itemize}

Be careful to use the aluminium plate with holes countersunk in the correct direction.
The credits plates are mirror images of the cpu3 plates.

Screw the standoffs to the plate using M3 screws, 0.8 Nm.

Places bottom PEEK washers, board and top PEEK washers on the standoffs.
Screw in place using M3 screws, 0.8 Nm.

Screw the finished module to the skeleton using M3 screws, 0.8 Nm.

Perform a power-on test.

\subsection{fieldmill9}

Parts needed:

\begin{itemize}
\item One (1) fieldmill9 / fieldmill\_top\_plate4 PCB assembly
\item One (1) fieldmill aluminium top plate
\item One (1) fieldmill shutter plate
\item One (1) Maxon 349694 EC motor
\item Stencil with a 15x5 mm hole
\item Two (2) 100 µm stainless steel motor shims
\item One (1) ITR20001/T IR reflex coupler
\item Three (3) M2 screws, 6 mm length including head (Phillips PH1)
\item Four (4) silver plated M3 screws, 10 mm length including head (Torx T10)
\item Sixteen (16) silver plated M3 screws. Same as above??
\item Four (4) M3 washers
\item Four (4) M3 hex nuts
\item One (1) M4 X 8/8 hex screw with 2 mm hole drilled through, preferably silver plated or silver painted if {\it someone} forgot to order silver plated M4 screws
\item One (1) silver plated M4 flange nut
\end{itemize}

Cut motor wires to 6-7 mm length.
Strip so that 3 mm of insulation remains, with the wire stripper set to 0.4 mm.
Twist and tin the ends of the wires.

Put the stencil on the rotor can, tape it down using masking tape and paint the area matt black.
One way to do this is to spray primer into a glass or glazed ceramic cup then dip a fine paintbrush into the primer and paint it onto the can.
DO NOT USE A PLASTIC CUP TO HOLD THE PRIMER - IT WILL MELT.
Wait at least 30 minutes for the primer to dry, then apply the matt black paint on top of it.
The black painted area should cover roughly a 90° arc of the edge of the can.

Use a small semi-round file to grind away the perforation remains in the middle hole of the PCB,
so that a motor will fit loosely.

Mount the Maxon EC motor in the motor hole with two motor shims inbetween.
The shims should raise the motor enough that a small lip / edge can be felt on the top side of the assembly between the motor housing and the fieldmill\_top\_plate4 PCB.
Solder the five motor wires to the motor wire pads on the PCB.

Bend and cut the IR reflex coupler leads so that the reflex coupler looks directly at the EC motor's rotor can when inserted into its 2x3 socket (IR2 reference on PCB).
Bending then trimming all leads to the same length as the shortest lead will accomplish this,
The resulting lead length should be 7 mm from the bottom of the reflex coupler.
Insert the reflex coupler into its socket.
The gap between the top of the 2x3 socket and the bottom of the reflex coupler should be 2 - 3 mm.
Solder the reflex coupler into the socket. Use plenty of flux so the leads and socket are guaranteed to be soldered together.
Some extra solder can be applied to the 2x3 socket pads at this point.
Carefully test that pulling on the reflex coupler doesn't cause it to come out.
Check continuity with a multimeter, and that adjacent pins aren't shorted.

Screw the motor + PCB assembly to the aluminium plate using the M2 screws for the motor and silver plated M3 screws, washers and nuts for the PCB.
First screw in the screws lightly, then tighten using the torque wrench. Use 0.3 Nm for the M2 screws and 0.8 Nm for the M3 nuts.

Use a toothpick to paint the motor bearing with SCP03G silver paint.
Be careful not to get silver paint on the motor axis.
There should be a slight resistance in the bearings which will go away after the first initial minutes of operation.

Use Loctite 638 to glue the M4 screw to the motor axis.
Mount the screw so that the head points downward, toward the instrument,
and so that it is flush with the inner ring of the motor bearing.
When the glue has dried, put the motor can in the specially shaped vice.
Put the shutter plate on the M4 screw and fasten it using the M4 flange nut.
Torque to 2.0 Nm.
Drop some SCP03G silver paint into the top of the screw so that it gets a good electrical connection to the motor shaft.

Screw each module to the skeleton using M3 screws, 0.8 Nm.

Perform power-on test and motor test.
Measure the resistance between motor axis and instrument ground after running the motor for a few minutes.
The resistance should be less than 10 $\Omega$.


\subsection{credits}

\begin{itemize}
\item One (1) credits PCB, soldered and cleaned
\item One (1) silver plated credits aluminium plate
\item One (1) cpu3/credits aluminium standoff, short kind
\item One (1) cpu3/credits aluminium standoff, long kind
\item Four (4) PEEK washers (top kind)
\item Four (4) PEEK washers (bottom kind)
\item Twentyfour (24) silver plated M3 screws, ?? length inluding head (Torx T10)
\end{itemize}

Be careful to use the aluminium plate with holes countersunk in the correct direction.
The credits plates are mirror images of the cpu3 plates.

Screw the standoffs to the plate using M3 screws, 0.8 Nm.

Places bottom PEEK washers, board and top PEEK washers on the standoffs.
Screw in place using M3 screws, 0.8 Nm.

Screw the finished module to the skeleton using M3 screws, 0.8 Nm.

Perform a power-on test and a thermometer test.

\section{Commands}

All commands are human-readable, start with a single ASCII character and are termianted with a line ending.
If the command takes no parameters then the line ending is optional.
Comments may be added by inserting a hash sign ('\#').
This causes the rest of the line to be ignored (characters are consumed and discarded until end-of-line).
Parameter parsing is handled by sscanf(), which allows for the same command character to take a varying number
of parameters. An example of this is the 'M' command which exists in two-parameter and three-parameter forms:

\begin{lstlisting}
    M0 10       # Set speed of motor 0 to 10
    M10 10 10   # Set speed of all motors to 10
\end{lstlisting}


Line endings can either be carriage return ('{\textbackslash}r', ASCII code 13) or linefeed ('{\textbackslash}n', ASCII code 10), but never both in the same line.
In other words both Unix and Mac line endings are OK, but Windows line endings ("{\textbackslash}r{\textbackslash}n") are not.
This ensures both {\it echo} and {\it minicom} works as expected.
Output from the instrument is terminated by Windows line endings however, in order to work well with {\it minicom}.

Table \vref{command_table} summarizes all commands and their parameters.
More detailed descriptions of each command are given in the subsections that follow.

\definecolor{lgray}{gray}{0.95}
\definecolor{dgray}{gray}{0.90}

\begin{table}[H]
\begin{centering}
\rowcolors{1}{lgray}{dgray}
\begin{tabular}{|p{1.8cm}|p{1.8cm}|p{1.8cm}|p{5cm}|}
\hline
{\bf Command} & {\bf Parameter count} & {\bf Parameter syntax} & {\bf Description} \\ \hline
v & 0 &                     & Measure system voltages \\ \hline
V & 0 &                     & Enable 24V and +-5V \\ \hline
B & 0 &                     & Disable 24V and +-5V \\ \hline
m & 0 &                     & Read motor speeds \\ \hline
M & 2 & ID spd              & Set motor speed \\ \hline
M & 3 & spd spd spd         & Set motor speeds \\ \hline
K & 0 &                     & Set motor speeds to 50\% \\ \hline
  & 0 &                     & Stop all motors \\ \hline
  & 1 & ID                  & Stop specific motor \\ \hline
  & 0 &                     & Measure motor speeds in RPM \\ \hline
  & 1 &                     & Measure specific motor speed in RPM \\ \hline
1 & 0 &                     & List 1-wire device ROMs \\ \hline
! & 0 &                     & Search for 1-wire devices \\ \hline
  &   &                     & Measure temperatures \\ \hline
  &   &                     & Configure ADC \\ \hline
  &   &                     & Read ADC configuration \\ \hline
  &   &                     & Read registers (\$0000 - \$00FF) \\ \hline
  &   &                     & Write registers (\$0000 - \$00FF) \\ \hline
  &   &                     & Read RAM (\$0100 - \$FFFF) \\ \hline
  &   &                     & Write RAM (\$0100 - \$FFFF) \\ \hline
  &   &                     & Read EEPROM (\$000 - \$FFF) \\ \hline
  &   &                     & Write EEPROM (\$000 - \$FFF) \\ \hline
  &   &                     & Read ROM (\$00000 - \$1FFFF) \\ \hline
  &   &                     & Read fuses \\ \hline
  &   &                     & Read clock \\ \hline
  &   &                     & Set clock \\ \hline
  &   &                     & Configure measurement (block size + gap) \\ \hline
  &   &                     & Read measurement configuration \\ \hline
  &   &                     & Start measurement \\ \hline
{\textbackslash}x1B (ESC)  &   &                     & Stop measurement \\ \hline
\end{tabular}
\caption{Command table}
\label{command_table}
\end{centering}
\end{table}

\subsection{Read motor speed ('m')}

Prints three integers containing OCR1A, OCR1B and OCR1C respectively.
0 - 255 roughly corresponding to 0 - 100\% or 0 - 6000 RPM.

\subsection{Set motor speed(s) ('M')}

Hardware will refuse if values are so low that they risk turning the motors off.

\section{Listing}

\lstinputlisting{sample_packet_s.h}



\end{document}
